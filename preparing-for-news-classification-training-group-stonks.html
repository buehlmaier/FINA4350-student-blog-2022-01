<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" type="text/css" href="https://buehlmaier.github.io/FINA4350-student-blog-2022-01/theme/css/elegant.prod.9e9d5ce754.css" media="screen">
        <link rel="stylesheet" type="text/css" href="https://buehlmaier.github.io/FINA4350-student-blog-2022-01/theme/css/custom.css" media="screen">

        <link rel="dns-prefetch" href="//fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com/" crossorigin>

        <meta name="author" content="FINA4350 Students" />

        <meta property="og:type" content="article" />
        <meta name="twitter:card" content="summary">

<meta name="keywords" content=", Progress Report, " />

<meta property="og:title" content="Preparing for news classification training (Group Stonks) "/>
<meta property="og:url" content="https://buehlmaier.github.io/FINA4350-student-blog-2022-01/preparing-for-news-classification-training-group-stonks.html" />
<meta property="og:description" content="By JIANG Zeyu and HUANG Yining of group Stonks Introduction We now have tokenized news data and stock prices data retrieved from yahoo. We want to find out the relations between them using deep learning techniques to sort of predict the stock movement based on news. We have ordered the …" />
<meta property="og:site_name" content="FINA4350 Student Blog" />
<meta property="og:article:author" content="FINA4350 Students" />
<meta property="og:article:published_time" content="2022-04-19T01:12:00+08:00" />
<meta name="twitter:title" content="Preparing for news classification training (Group Stonks) ">
<meta name="twitter:description" content="By JIANG Zeyu and HUANG Yining of group Stonks Introduction We now have tokenized news data and stock prices data retrieved from yahoo. We want to find out the relations between them using deep learning techniques to sort of predict the stock movement based on news. We have ordered the …">

        <title>Preparing for news classification training (Group Stonks)  · FINA4350 Student Blog
</title>
        <link href="https://buehlmaier.github.io/FINA4350-student-blog-2022-01/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="FINA4350 Student Blog - Full Atom Feed" />



    </head>
    <body>
        <div id="content">
            <div class="navbar navbar-static-top">
                <div class="navbar-inner">
                    <div class="container-fluid">
                        <a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                            <span class="icon-bar"></span>
                        </a>
                        <a class="brand" href="https://buehlmaier.github.io/FINA4350-student-blog-2022-01/"><span class=site-name>FINA4350 Student Blog</span></a>
                        <div class="nav-collapse collapse">
                            <ul class="nav pull-right top-menu">
                                <li >
                                    <a href=
                                       https://buehlmaier.github.io/FINA4350-student-blog-2022-01
                                    >Home</a>
                                </li>
                                <li ><a href="https://buehlmaier.github.io/FINA4350-student-blog-2022-01/categories.html">Categories</a></li>
                                <li ><a href="https://buehlmaier.github.io/FINA4350-student-blog-2022-01/tags.html">Tags</a></li>
                                <li ><a href="https://buehlmaier.github.io/FINA4350-student-blog-2022-01/archives.html">Archives</a></li>
                                <li><form class="navbar-search" action="https://buehlmaier.github.io/FINA4350-student-blog-2022-01/search.html" onsubmit="return validateForm(this.elements['q'].value);"> <input type="text" class="search-query" placeholder="Search" name="q" id="tipue_search_input"></form></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            <div class="container-fluid">
                <div class="row-fluid">
                    <div class="span1"></div>
                    <div class="span10">
<article itemscope>
<div class="row-fluid">
    <header class="page-header span10 offset2">
        <h1>
            <a href="https://buehlmaier.github.io/FINA4350-student-blog-2022-01/preparing-for-news-classification-training-group-stonks.html">
                Preparing for news classification training (Group Stonks)
            </a>
        </h1>
    </header>
</div>

<div class="row-fluid">
        <div class="span8 offset2 article-content">
            
            <p>By JIANG Zeyu and HUANG Yining of group Stonks</p>
<h1>Introduction</h1>
<p>We now have tokenized news data and stock prices data retrieved from yahoo. We want to find out the relations between them using deep learning techniques to sort of predict the stock movement based on news. We have ordered the news by date, and give each date a label which indicates stock movement, i.e. increase, decrease, in a future period from that date.</p>
<h1>Workflow</h1>
<h2>1. Generate feature matrix</h2>
<p>Since computer cannot understand natural language directly, we have to turn them into pure numbers. We could do this by constructing a word database that give each word an index, and simply use 0,1 to mark the stock increase and decrease. However, the length of news would not be the same in most cases, we have to decide a max_length for one news piece and add padding to news that is shorter than max_length.</p>
<p>Also, with all the news pieces we gathered, we need to divide them into two sets, i.e. train set and test test, so that we could validate accuracy of our trained model. It should be notice that, feature matrix of train set should share a same words index database with feature matrix of test set, or the mapping will be destroyed.</p>
<p>We first define a class for feature matrix of train set which could accept sentences and labels. It should be able to generate a dictionary named <strong><em>wordToIndex</em></strong> and its feature matrix.</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">FeatureMatrixTrain</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Initial raw matrix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wordToIndex</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">indexToWord</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">currentIndex</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wordCountByIndex</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sentences</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wordToIndexReduced</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="c1"># Final matrix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fm</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">appendToken</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">word</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Add word if not exist, or just increase its count</span>
        <span class="k">if</span> <span class="n">word</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">wordToIndex</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wordCountByIndex</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">wordToIndex</span><span class="p">[</span><span class="n">word</span><span class="p">]]</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Add word to wordToIndex mapping</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wordToIndex</span><span class="p">[</span><span class="n">word</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">currentIndex</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">indexToWord</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">word</span><span class="p">)</span>
            <span class="c1"># Move pointer</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wordCountByIndex</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">currentIndex</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">currentIndex</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">appendTokens</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tokens</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">priceChange</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">sentencesIdx</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">tokens</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">appendToken</span><span class="p">(</span><span class="n">token</span><span class="p">)</span>
            <span class="n">sentencesIdx</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wordToIndex</span><span class="p">[</span><span class="n">token</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sentences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sentencesIdx</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">priceChange</span><span class="p">)</span>
</code></pre></div>

<p>While iterate through news, we will add news to train set and also test set. To avoid repeatedly iterating, we firstly just add news to test set, and map the words after the feature matrix and wordToIndex are constructed in the train set.</p>
<div class="highlight"><pre><span></span><code><span class="k">class</span> <span class="nc">FeatureMatrixTest</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sentences</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wordToIndex</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
        <span class="c1"># Final matrix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">features</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fm</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">appendTokens</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tokens</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">priceChange</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sentences</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">priceChange</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">mappingWordIndex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">wordToIndex</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wordToIndex</span> <span class="o">=</span> <span class="n">wordToIndex</span>
        <span class="n">unknown</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wordToIndex</span><span class="p">[</span><span class="s2">&quot;UNKNOWN&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">sentence</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sentences</span><span class="p">):</span>
            <span class="n">newSentence</span> <span class="o">=</span> <span class="p">[</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">wordToIndex</span><span class="p">[</span><span class="n">token</span><span class="p">]</span> <span class="k">if</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">wordToIndex</span> <span class="k">else</span> <span class="n">unknown</span> <span class="k">for</span> <span class="n">token</span> <span class="ow">in</span> <span class="n">sentence</span><span class="p">]</span>
            <span class="c1"># Add padding to make equalized sentence, here choose 30 as maximum words in one sentence</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">newSentence</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">30</span><span class="p">:</span>
                <span class="n">newSentence</span> <span class="o">=</span> <span class="n">newSentence</span><span class="p">[:</span><span class="mi">30</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">newSentence</span> <span class="o">=</span> <span class="n">newSentence</span> <span class="o">+</span> <span class="p">[</span><span class="nb">len</span><span class="p">(</span><span class="n">wordToIndex</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">30</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">newSentence</span><span class="p">))</span>
            <span class="c1"># Add label</span>
            <span class="n">newSentence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">index</span><span class="p">])</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">newSentence</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">Finished sentence #</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">index</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fm</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">features</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Finished mapping&quot;</span><span class="p">)</span>
</code></pre></div>

<p>It should be noticed that we haven't implement <em>padding</em> in feature matirx of train set, since we would do that when implementing reduce vocabulary functions. Just after we've defined these two class, we could iterate our data and add them into two matrices.</p>
<div class="highlight"><pre><span></span><code><span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">tickers</span><span class="p">:</span>
    <span class="c1"># News data are in json format</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;./data/news/&quot;</span><span class="o">+</span><span class="n">ticker</span><span class="o">+</span><span class="s2">&quot;.json&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">news</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;./data/prices_processed/&quot;</span><span class="o">+</span><span class="n">ticker</span><span class="o">+</span><span class="s2">&quot;.json&quot;</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">prices</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="c1"># Iterate news to match with prices data</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">news</span><span class="p">:</span>
        <span class="n">dateOfNews</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span>
            <span class="n">item</span><span class="p">[</span><span class="s2">&quot;updated_at&quot;</span><span class="p">],</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">T%H:%M:%SZ&quot;</span><span class="p">)</span>
        <span class="n">dateStrOfNews</span> <span class="o">=</span> <span class="n">dateOfNews</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="c1"># Check in prices data</span>
        <span class="k">if</span> <span class="n">dateStrOfNews</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">prices</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="c1"># Divide into two sets</span>
        <span class="n">sampleId</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="c1"># Tokenize</span>
        <span class="n">rawContent</span> <span class="o">=</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;title&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">+</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span>
        <span class="c1"># Remove url first</span>
        <span class="n">rawContent</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
            <span class="sa">r</span><span class="s1">&#39;(https|http)?:\/\/(\w|\.|\/|\?|\=|\&amp;|\%)*\b&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">rawContent</span><span class="p">)</span>
        <span class="c1"># We tokenize and clean our news content here</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="n">tokenizeContent</span><span class="p">(</span><span class="n">rawContent</span><span class="p">,</span> <span class="n">stopwords</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">sampleId</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="c1"># Test set</span>
            <span class="n">fmTest</span><span class="o">.</span><span class="n">appendTokens</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="n">prices</span><span class="p">[</span><span class="n">dateStrOfNews</span><span class="p">][</span><span class="s1">&#39;week&#39;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Train set</span>
            <span class="n">fmTrain</span><span class="o">.</span><span class="n">appendTokens</span><span class="p">(</span><span class="n">tokens</span><span class="p">,</span> <span class="n">prices</span><span class="p">[</span><span class="n">dateStrOfNews</span><span class="p">][</span><span class="s1">&#39;week&#39;</span><span class="p">])</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\r</span><span class="s2">Finished sampling #</span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sampleId</span><span class="p">))</span>
<span class="c1"># Construct mapping for test set</span>
<span class="n">fmTest</span><span class="o">.</span><span class="n">mappingWordIndex</span><span class="p">(</span><span class="n">fmTrain</span><span class="o">.</span><span class="n">wordToIndexReduced</span><span class="p">)</span>
</code></pre></div>

<div class="highlight"><pre><span></span><code><span class="err">##</span><span class="w"> </span><span class="mf">2.</span><span class="w"> </span><span class="n">Vocabulary</span><span class="w"> </span><span class="n">reduction</span><span class="w"></span>

<span class="n">However</span><span class="p">,</span><span class="w"> </span><span class="n">there</span><span class="w"> </span><span class="k">are</span><span class="w"> </span><span class="n">still</span><span class="w"> </span><span class="ow">some</span><span class="w"> </span><span class="n">problems</span><span class="w"> </span><span class="ow">like</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">super</span><span class="w"> </span><span class="k">large</span><span class="w"> </span><span class="n">vocabularies</span><span class="w"> </span><span class="n">would</span><span class="w"> </span><span class="n">let</span><span class="w"> </span><span class="n">our</span><span class="w"> </span><span class="n">deep</span><span class="w"> </span><span class="n">learning</span><span class="w"> </span><span class="n">model</span><span class="w"> </span><span class="n">have</span><span class="w"> </span><span class="n">too</span><span class="w"> </span><span class="n">much</span><span class="w"> </span><span class="n">vectors</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">follow</span><span class="p">,</span><span class="w"> </span><span class="n">resulting</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">loss</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">accuracy</span><span class="p">.</span><span class="w"> </span><span class="n">Therefore</span><span class="p">,</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">decide</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">reduce</span><span class="w"> </span><span class="n">our</span><span class="w"> </span><span class="n">vocabulary</span><span class="p">.</span><span class="w"> </span><span class="n">It</span><span class="w"> </span><span class="n">should</span><span class="w"> </span><span class="k">include</span><span class="w"> </span><span class="n">process</span><span class="w"> </span><span class="n">that</span><span class="w"> </span><span class="n">sort</span><span class="w"> </span><span class="n">words</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="n">according</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">words</span><span class="w"> </span><span class="n">frequency</span><span class="p">,</span><span class="w"> </span><span class="n">constructing</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">words</span><span class="p">,</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">do</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">mapping</span><span class="w"> </span><span class="k">from</span><span class="w"> </span><span class="k">old</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="k">index</span><span class="p">.</span><span class="w"></span>

<span class="n">Since</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">haven</span><span class="s1">&#39;t done padding process for our train set&#39;</span><span class="n">s</span><span class="w"> </span><span class="n">feature</span><span class="w"> </span><span class="n">matrix</span><span class="p">,</span><span class="w"> </span><span class="n">the</span><span class="w"> </span><span class="n">number</span><span class="w"> </span><span class="k">of</span><span class="w"> </span><span class="n">columns</span><span class="w"> </span><span class="k">are</span><span class="w"> </span><span class="n">matched</span><span class="w"> </span><span class="ow">and</span><span class="w"> </span><span class="n">we</span><span class="w"> </span><span class="n">haven</span><span class="s1">&#39;t add labels to them, we will do it during our vocabulary reduction process.</span>

<span class="s1">Add following functions into class FeatureMatrixTrain. Here we limit the max length of news being 30 words.</span>

<span class="s1">```python</span>
<span class="s1">def reduceVocab(self, vocabSize: int) -&gt; None:</span>
<span class="s1">    # Initialize a smaller wordToIndex</span>
<span class="s1">    wordToIndexReduced = {}</span>
<span class="s1">    newIndex = 0</span>
<span class="s1">    indexMap = {}</span>
<span class="s1">    # Sorted and reduce size</span>
<span class="s1">    sortedWordCountByIndex = sorted(</span>
<span class="s1">        self.wordCountByIndex.items(), key=operator.itemgetter(1), reverse=True)</span>
<span class="s1">    sortedWordCountByIndex = sortedWordCountByIndex[:vocabSize]</span>
<span class="s1">    print(&quot;Sorted by word count&quot;)</span>
<span class="s1">    # Construct mapping from old index to new index</span>
<span class="s1">    for index, count in sortedWordCountByIndex:</span>
<span class="s1">        word = self.indexToWord[index]</span>
<span class="s1">        wordToIndexReduced[word] = newIndex</span>
<span class="s1">        indexMap[index] = newIndex</span>
<span class="s1">        newIndex += 1</span>
<span class="s1">    print(&quot;Constructed mapping from old index to new index for train set&quot;)</span>
<span class="s1">    # Using capital unknown to avoid duplication</span>
<span class="s1">    wordToIndexReduced[&#39;</span><span class="k">UNKNOWN</span><span class="err">&#39;]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newIndex</span><span class="w"></span>
<span class="w">    </span><span class="k">unknown</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newIndex</span><span class="w"></span>
<span class="w">    </span><span class="n">self</span><span class="p">.</span><span class="n">wordToIndexReduced</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">wordToIndexReduced</span><span class="w"></span>
<span class="w">    </span><span class="err">#</span><span class="w"> </span><span class="n">Remap</span><span class="w"> </span><span class="n">word</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">sentences</span><span class="w"> </span><span class="k">with</span><span class="w"> </span><span class="k">new</span><span class="w"> </span><span class="k">index</span><span class="w"></span>
<span class="w">    </span><span class="k">for</span><span class="w"> </span><span class="k">index</span><span class="p">,</span><span class="w"> </span><span class="n">sentence</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">enumerate</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">sentences</span><span class="p">)</span><span class="err">:</span><span class="w"></span>
<span class="w">        </span><span class="n">newSentence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">[</span><span class="n"></span>
<span class="n">            indexMap[index</span><span class="o">]</span><span class="w"> </span><span class="k">if</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">indexMap</span><span class="w"> </span><span class="k">else</span><span class="w"> </span><span class="k">unknown</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="k">index</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">sentence</span><span class="err">]</span><span class="w"></span>
<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="k">Add</span><span class="w"> </span><span class="n">padding</span><span class="w"> </span><span class="k">to</span><span class="w"> </span><span class="n">make</span><span class="w"> </span><span class="n">equalized</span><span class="w"> </span><span class="n">sentence</span><span class="p">,</span><span class="w"> </span><span class="n">here</span><span class="w"> </span><span class="nf">choose</span><span class="w"> </span><span class="mi">30</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="n">maximum</span><span class="w"> </span><span class="n">words</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">one</span><span class="w"> </span><span class="n">sentence</span><span class="w"></span>
<span class="w">        </span><span class="k">if</span><span class="w"> </span><span class="nf">len</span><span class="p">(</span><span class="n">newSentence</span><span class="p">)</span><span class="w"> </span><span class="o">&gt;</span><span class="w"> </span><span class="mi">30</span><span class="err">:</span><span class="w"></span>
<span class="w">            </span><span class="n">newSentence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newSentence</span><span class="o">[</span><span class="n">:30</span><span class="o">]</span><span class="w"></span>
<span class="w">        </span><span class="k">else</span><span class="err">:</span><span class="w"></span>
<span class="w">            </span><span class="n">newSentence</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">newSentence</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="o">[</span><span class="n">len(wordToIndexReduced) - 1</span><span class="o">]</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="p">(</span><span class="mi">30</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="nf">len</span><span class="p">(</span><span class="n">newSentence</span><span class="p">))</span><span class="w"></span>
<span class="w">        </span><span class="err">#</span><span class="w"> </span><span class="k">Add</span><span class="w"> </span><span class="n">label</span><span class="w"></span>
<span class="w">        </span><span class="n">newSentence</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">labels</span><span class="o">[</span><span class="n">index</span><span class="o">]</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">self</span><span class="p">.</span><span class="n">features</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">newSentence</span><span class="p">)</span><span class="w"></span>
<span class="w">        </span><span class="n">sys</span><span class="p">.</span><span class="n">stdout</span><span class="p">.</span><span class="k">write</span><span class="p">(</span><span class="ss">&quot;\rFinished sentence #{}&quot;</span><span class="p">.</span><span class="nf">format</span><span class="p">(</span><span class="k">index</span><span class="p">))</span><span class="w"></span>
<span class="w">    </span><span class="n">self</span><span class="p">.</span><span class="n">fm</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">np</span><span class="p">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">self</span><span class="p">.</span><span class="n">features</span><span class="p">)</span><span class="w"></span>
<span class="w">    </span><span class="k">print</span><span class="p">(</span><span class="ss">&quot;\nFinished mapping&quot;</span><span class="p">)</span><span class="w"></span>
</code></pre></div>

<p>We won't need to modify any functions in FeatureMatrixTest, we just call fmTest.mappingWordIndex after we call reduceVocab of FeatureMatrixTrain, and pass the reduced wordToIndex.</p>
<p>Then, we could just directly save two featureMatrices and wordToIndex to files for our later training and testing process.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Save files</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;./data/wordToIndex&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">fmTrain</span><span class="o">.</span><span class="n">wordToIndexReduced</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;./data/train/featureMatrix&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">fmTrain</span><span class="o">.</span><span class="n">fm</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;./data/test/featureMatrix&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
    <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">fmTest</span><span class="o">.</span><span class="n">fm</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div>

<h2>3. Model Construction</h2>
<h3>Choose of neural network</h3>
<p>We firstly encounter with the choice between convolutional neural network, CNN and recurrent neural network, RNN, which are classified by characteristics of neural and are kind of evolution of DNN.</p>
<p>DNN is artificial neural network (ANN) with multiple layers between the input and output layers, while CNN is encoded with space dimension, and RNN is encoded with time dimension.</p>
<p>To clarify, we could construct the simplest DNN by connecting each layer fully, that all outputs of previous layer serves as input of next layer, which will not suit our case, since not every word appears each time and last news may not have link with next layer.</p>
<p>When take a look at RNN, it requires there are time-linked relationships with in one entry. For example, if one word is "I" the next word might be "like". However, after our processing, this link has been weakened. For each time step, they may not share same arguments. Therefore, CNN which make the words like a large word cloud and to find relationships would be our choice.</p>
<h3>Construction of CNN model</h3>
<p>We start a scratch from pytorch nn module</p>
<div class="highlight"><pre><span></span><code><span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="nn">nn</span>

<span class="k">class</span> <span class="nc">CNN_News</span><span class="p">(</span><span class="n">nn</span><span class="o">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="c1"># Call parent constructor</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">CNN_News</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>

        <span class="c1"># Multiple List of CONV =&gt; RELU =&gt; POOL layers</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">convs</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">ModuleList</span><span class="p">([</span><span class="n">nn</span><span class="o">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">KERNEL_NUM</span><span class="p">,</span> <span class="p">(</span><span class="n">K</span><span class="p">,</span> <span class="n">EMBEDED_DIMENSION</span><span class="p">)</span> <span class="k">for</span> <span class="n">K</span> <span class="ow">in</span> <span class="n">KERNEL_SIZES</span><span class="p">)]</span>
        <span class="c1"># Dropout and other improvement</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dropout</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Dropout</span><span class="p">(</span><span class="n">dropout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fc</span> <span class="o">=</span> <span class="n">nn</span><span class="o">.</span><span class="n">Linear</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">kernel_sizes</span><span class="p">)</span> <span class="o">*</span> <span class="n">kernel_dim</span><span class="p">,</span> <span class="n">output_size</span><span class="p">)</span>
</code></pre></div>

<p>Here, we ignore some settings of parameters, which really depends on your data.</p>
<ul>
<li>KERNEL_NUM: You could view this as the number of filters, which we would use filters to shade our data, to focus on a specific area of data. After computing them, we could move to next area.</li>
<li>EMBEDED_DIMENSION: This parameter is hugely depended on the size of your data, since it would use to assign vectors. Let's put it simply here, it's a number to specify how large would you make your network. If you want to learn how to set this number, you could refer to [AutoEmb: Automated Embedding Dimensionality Search in Streaming Recommendations].</li>
</ul>
<p>Also, the convs could be illustrate as a for-loop. (Kernel sizes of (2,3,4))</p>
<div class="highlight"><pre><span></span><code><span class="err">self.conv13 = nn.Conv2d(Ci, Co, (2, D))</span>
<span class="err">self.conv14 = nn.Conv2d(Ci, Co, (3, D))</span>
<span class="err">self.conv15 = nn.Conv2d(Ci, Co, (4, D))</span>
</code></pre></div>

<p>Then we need to add functions to support max-pooling layer and softmax layer.</p>
<p>Max pooling layer will take maximum value of result (multiple one-dimension vector) of the convolution layer and make them together. Softmax layer will turn the result of pooling layer into classes we want to classify.</p>
<p>To view more details, you could refer to this <a href="https://pyimagesearch.com/2021/07/19/pytorch-training-your-first-convolutional-neural-network-cnn/">PyTorch: Training your first Convolutional Neural Network (CNN) - PyImageSearch</a>.</p>
<h1>What's Next</h1>
<p>Now, we've prepared enough for our training process. We could use the resouces to start our training quite easy while we may face a truly low accuracy. We may discover how to adjust parameters for our model and how to correctly use and test our model in our next blog post.</p>


             
 
            
            
            







            <hr/>
        </div>
        <section id="article-sidebar" class="span2">
            <h4>Published</h4>
            <time itemprop="dateCreated" datetime="2022-04-19T01:12:00+08:00">Tue 19 April 2022</time>
            <h4>Category</h4>
            <a class="category-link" href="https://buehlmaier.github.io/FINA4350-student-blog-2022-01/categories.html#progress-report-ref">Progress Report</a>
<h4>Contact</h4>
<div id="sidebar-social-link">
    <a href="https://github.com/buehlmaier/FINA4350-student-blog-2022-01" title="" target="_blank" rel="nofollow noopener noreferrer">
        <svg xmlns="http://www.w3.org/2000/svg" aria-label="GitHub" role="img" viewBox="0 0 512 512"><rect width="512" height="512" rx="15%" fill="#1B1817"/><path fill="#fff" d="M335 499c14 0 12 17 12 17H165s-2-17 12-17c13 0 16-6 16-12l-1-50c-71 16-86-28-86-28-12-30-28-37-28-37-24-16 1-16 1-16 26 2 40 26 40 26 22 39 59 28 74 22 2-17 9-28 16-35-57-6-116-28-116-126 0-28 10-51 26-69-3-6-11-32 3-67 0 0 21-7 70 26 42-12 86-12 128 0 49-33 70-26 70-26 14 35 6 61 3 67 16 18 26 41 26 69 0 98-60 120-117 126 10 8 18 24 18 48l-1 70c0 6 3 12 16 12z"/></svg>
    </a>
</div>
            





            





        </section>
</div>
</article>
<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    <!-- Background of PhotoSwipe.
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>

    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">

        <!-- Container that holds slides.
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                <!--  Controls are self-explanatory. Order can be changed. -->

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                <!-- Preloader demo https://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div>                    </div>
                    <div class="span1"></div>
                </div>
            </div>
        </div>
<footer>




    <div id="fpowered">
        Powered by: <a href="http://getpelican.com/" title="Pelican Home Page" target="_blank" rel="nofollow noopener noreferrer">Pelican</a>
        Theme: <a href="https://elegant.oncrashreboot.com/" title="Theme Elegant Home Page" target="_blank" rel="nofollow noopener noreferrer">Elegant</a>
    </div>
</footer>            <script src="//code.jquery.com/jquery.min.js"></script>
        <script src="//netdna.bootstrapcdn.com/twitter-bootstrap/2.3.2/js/bootstrap.min.js"></script>
        <script src="https://buehlmaier.github.io/FINA4350-student-blog-2022-01/theme/js/elegant.prod.9e9d5ce754.js"></script>
        <script>
            function validateForm(query)
            {
                return (query.length > 0);
            }
        </script>

    <script>
    (function () {
        if (window.location.hash.match(/^#comment-\d+$/)) {
            $('#comment_thread').collapse('show');
        }
    })();
    window.onhashchange=function(){
        if (window.location.hash.match(/^#comment-\d+$/))
            window.location.reload(true);
    }
    $('#comment_thread').on('shown', function () {
        var link = document.getElementById('comment-accordion-toggle');
        var old_innerHTML = link.innerHTML;
        $(link).fadeOut(200, function() {
            $(this).text('Click here to hide comments').fadeIn(200);
        });
        $('#comment_thread').on('hidden', function () {
            $(link).fadeOut(200, function() {
                $(this).text(old_innerHTML).fadeIn(200);
            });
        })
    })
</script>

    </body>
    <!-- Theme: Elegant built for Pelican
        License : MIT -->
</html>